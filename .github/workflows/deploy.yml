name: deploy

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      print_envs:
        description: 'True to print to STDOUT'
        required: true
        default: true
        type: boolean
      deploy-to-dev:
        description: 'Deploy to dev'
        required: true
        default: true
        type: boolean
      deploy-to-tst:
        description: 'Deploy to tst'
        required: true
        default: true
        type: boolean
      deploy-to-prd:
        description: 'Deploy to prd'
        required: true
        default: true
        type: boolean
      # tags:
      #   description: 'Test scenario tags'
      #   required: true
      #   type: string
      environment:
        description: 'Environment to run tests against'
        type: environment
        required: true
      environments:
        description: 'Environments?'
        type: string
        default: '["dev", "prd"]'
        required: true

jobs:
  # print-envs:
  #   strategy:
  #     max-parallel: 1
  #     matrix:
  #       environment: ${{ fromJson(inputs.environments) }}
  #   runs-on: ubuntu-latest
  #   if:  ${{ inputs.print_envs }} 
  #   steps:    
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/actions/deploy-to-env
  #       with:
  #         env: ${{ matrix.environment }}

  deploy-dev:
    name: Deploy to dev
    environment: dev
    runs-on: ubuntu-22.04
    if:  ${{ inputs.deploy-to-dev }} 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Terraform Apply
        uses: ./.github/actions/deploy-to-env
        with:
          env: dev
      - name: Do something
        run: cat asdf.txt
    # needs: [print-envs]

  deploy-tst:
      name: Deploy to tst
      environment: tst
      runs-on: ubuntu-22.04
      if:  ${{ inputs.deploy-to-tst }} 
      steps:
        - uses: trstringer/manual-approval@v1
          timeout-minutes: 1
          with:
            secret: ${{ github.TOKEN }}
            approvers: sindrel,bvestli
            minimum-approvals: 1
            issue-title: "ü•á Approve deployment to tst"
            issue-body: "Please approve or deny the deployment to tst"
            exclude-workflow-initiator-as-approver: false
            additional-approved-words: 'üëç,ja,supert,konge,sjef'
            additional-denied-words: 'üëé,nei,√¶sj,stopp,avbryt'
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Do something
          run: cat asdf.txt
      needs: [deploy-dev]

  deploy-prd:
      name: Deploy to prd
      environment: prd
      runs-on: ubuntu-22.04
      if:  ${{ inputs.deploy-to-prd }} 
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - name: Do something
          run: cat asdf.txt
      needs: [deploy-tst]