name: deploy

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      print_envs:
        description: 'True to print to STDOUT'
        required: true
        default: true
        type: boolean
      deploy-to-dev:
        description: 'Deploy to dev'
        required: true
        default: true
        type: boolean
      deploy-to-tst:
        description: 'Deploy to tst'
        required: true
        default: true
        type: boolean
      deploy-to-prd:
        description: 'Deploy to prd'
        required: true
        default: true
        type: boolean
      # tags:
      #   description: 'Test scenario tags'
      #   required: true
      #   type: string
      environment:
        description: 'Environment to run tests against'
        type: environment
        required: true
      environments:
        description: 'Environments?'
        type: string
        default: '["dev", "prd"]'
        required: true

jobs:
  # print-envs:
  #   strategy:
  #     max-parallel: 1
  #     matrix:
  #       environment: ${{ fromJson(inputs.environments) }}
  #   runs-on: ubuntu-latest
  #   if:  ${{ inputs.print_envs }} 
  #   steps:    
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/actions/deploy-to-env
  #       with:
  #         env: ${{ matrix.environment }}

  deploy-dev:
    name: Deploy to dev
    environment: dev
    runs-on: ubuntu-22.04
    if:  ${{ inputs.deploy-to-dev }} 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # - name: Diff
      #   id: diff-dev
      #   uses: yanamura/git-merge-diff@v1
      #   with:
      #       from: current-dev
      #       to: HEAD
      - name: Print diff
        id: print-diff-dev
        # run: echo "diff=$(git log current-dev..HEAD --first-parent)\n" >> $GITHUB_OUTPUT
        run: echo -e "diff<<EOF\n$(git log current-dev..HEAD --first-parent)\nEOF" >> $GITHUB_OUTPUT
      - name: Terraform Apply
        uses: ./.github/actions/deploy-to-env
        with:
          env: dev
      - name: Do something?
        run: cat asdf.txt
      - name: Set Git tag
        uses: weareyipyip/walking-tag-action@v2
        with:
          tag-name: current-dev
          tag-message: The current dev release is based on this commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # needs: [print-envs]

  deploy-tst:
      name: Deploy to tst
      environment: tst
      runs-on: ubuntu-22.04
      if:  ${{ inputs.deploy-to-tst }} 
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
      # - name: Diff
      #   id: diff-dev
      #   uses: yanamura/git-merge-diff@v1
      #   with:
      #       from: current-dev
      #       to: HEAD
        - name: Print diff
          id: print-diff-tst
          # run: git log current-tst..HEAD --first-parent >> $GITHUB_OUTPUT
          run: echo -e "diff<<EOF\n$(git log current-tst..HEAD --first-parent)\nEOF" >> $GITHUB_OUTPUT
        - uses: trstringer/manual-approval@v1
          timeout-minutes: 1
          with:
            secret: ${{ github.TOKEN }}
            approvers: sindrel,bvestli
            minimum-approvals: 1
            issue-title: "ü•á Approve deployment to tst"
            issue-body: "Please approve or deny the deployment to tst ${{ steps.print-diff-tst.outputs.diff }}"
            exclude-workflow-initiator-as-approver: false
            additional-approved-words: 'üëç,ja,supert,konge,sjef'
            additional-denied-words: 'üëé,nei,√¶sj,stopp,avbryt'
        - name: Do something!
          run: cat asdf.txt
        - name: Set Git tag
          uses: weareyipyip/walking-tag-action@v2
          with:
            tag-name: current-tst
            tag-message: The current tst release is based on this commit
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      needs: [deploy-dev]

  deploy-prd:
      name: Deploy to prd
      environment: prd
      runs-on: ubuntu-22.04
      if:  ${{ inputs.deploy-to-prd }} 
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
      # - name: Diff
      #   id: diff-dev
      #   uses: yanamura/git-merge-diff@v1
      #   with:
      #       from: current-dev
      #       to: HEAD
        - name: Print diff
          id: print-diff-prd
          run: echo -e "diff<<EOF\n$(git log current-prd..HEAD --first-parent)\nEOF" >> $GITHUB_OUTPUT
        - name: Do something
          run: cat asdf.txt
        - name: Set Git tag
          uses: weareyipyip/walking-tag-action@v2
          with:
            tag-name: current-prd
            tag-message: The current prd release is based on this commit
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      needs: [deploy-tst]